<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Raio-X Score 5 - DIRETA MG</title>
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para CSV robusto -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-4Yf2G+Wm1s6X+F1lY8m/4gq6xYw3y3M+eXfm1j3k6J2O7oBq3k9b6m1j1/0CJk0kz6UE0p3b9h6t1I5G4Dk2dg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Mantive todo seu CSS original, com pequenas adi√ß√µes para spinner/progress e fade-ins */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #171717 0%, #0a0a0a 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- (coloquei aqui somente as mudan√ßas/adi√ß√µes principais, o restante do CSS do seu arquivo original foi preservado) --- */

        .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px);} to { opacity:1; transform:translateY(0);} }

        /* Barra de progresso no header */
        .progress-bar-wrap {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 4px;
            background: transparent;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f59e0b, #d97706);
            transition: width 350ms linear;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Overlay loading */
        .overlay-loading {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: linear-gradient(0deg, rgba(10,10,10,0.45), rgba(10,10,10,0.45));
            z-index: 40;
        }
        .overlay-loading.show { display:flex; }

        /* Typing and message styles - kept similar to original for consistency */
        .message-container { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:1rem; }
        .message { max-width:85%; padding:.875rem 1rem; border-radius:1.25rem; line-height:1.5; font-size:.875rem; position:relative; word-wrap:break-word; }
        .message.user { align-self:flex-end; background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:#000; font-weight:600; }
        .message.bot { align-self:flex-start; background:#fef3c7; color:#92400e; border:1px solid rgba(245,158,11,0.15); }

        /* small util */
        .muted { color: rgba(0,0,0,0.6); font-size: .85rem; }

        /* responsive adjustments kept as in original */
    </style>
</head>
<body>
    <!-- TELA DE BOAS-VINDAS -->
    <div id="welcome-screen" class="flex flex-col items-center justify-center text-center p-6 min-h-screen relative">
        <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle at 25% 25%, rgba(245,158,11,0.3) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(245,158,11,0.2) 0%, transparent 50%);"></div>

        <h1 class="text-3xl sm:text-4xl md:text-5xl font-black text-white mb-4 drop-shadow-2xl fade-in">Raio-X Score 5</h1>
        <p id="subtitle-typing" class="text-xl sm:text-2xl text-amber-300 mb-8 h-8 font-semibold fade-in"></p>

        <img id="robot-gif" src="https://camo.githubusercontent.com/b36e635669f8d0b7db820aaee45ce243914addc6aa3ef74bb3da89c8f119d8a3/68747470733a2f2f6d65646961302e67697068792e636f6d2f6d656469612f76312e59326c6b505463354d4749334e6a45786554493365546c745a47567a4d3256784f5759784d57497862326f7a617a6c3364473031644849334e32526a64573434636a6b774f435a6c634431324d563970626e526c636d35686246396e61575a66596e6c666157516d5933513963772f386c5565313937564e48396937653455435a2f67697068792e676966" alt="Rob√¥ IA DIRETA MG" class="w-40 h-40 mx-auto my-6 object-contain animate-bounce" />

        <p class="text-sm text-gray-300 mb-8 font-medium fade-in">ü§ñ Desenvolvido pela <span class="text-amber-400 font-bold">DIRETA MG</span></p>

        <div class="flex gap-4">
            <button id="start-chat-button" class="px-6 py-3 rounded-full font-bold bg-gradient-to-r from-amber-500 to-amber-600 text-black shadow-lg hover:scale-105 transition-transform">üöÄ Iniciar Conversa</button>
            <button id="force-preload" class="px-4 py-3 rounded-full font-medium border border-amber-400 text-amber-200 hover:bg-amber-600/10 transition">‚§ì Carregar Planilha Agora</button>
        </div>
    </div>

    <!-- CHAT PHONE CONTAINER (inicialmente hidden) -->
    <div id="phone-container" class="hidden max-w-md mx-auto h-screen relative bg-gradient-to-br from-yellow-50 to-yellow-200 shadow-2xl" style="border-radius:20px; overflow:hidden;">
        <!-- header -->
        <div class="relative p-4 flex items-center justify-between" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-black/75 flex items-center justify-center text-xl">ü§ñ</div>
                <div>
                    <div id="header-title" class="font-extrabold text-black">Raio-X Score 5</div>
                    <div id="chat-status" class="text-sm muted">IA Conversacional - Aguardando</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="close-chat-button" class="text-2xl font-thin">√ó</button>
            </div>

            <div class="progress-bar-wrap">
                <div id="progress-bar" class="progress-bar" style="width:0%"></div>
            </div>
        </div>

        <!-- mensagens -->
        <div id="message-container" class="message-container bg-[url('data:image/svg+xml,%3Csvg width=60 height=60 viewBox=0 0 60 60 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cg fill=%22none%22 fill-rule=%22evenodd%22%3E%3Cg fill=%22%23f59e0b%22 fill-opacity=%220.03%22%3E%3Cpath d=%22M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] p-4"></div>

        <!-- typing -->
        <div id="typing-indicator" class="hidden p-3">
            <span class="inline-flex gap-2 items-center py-2 px-3 rounded-full bg-yellow-100/60">
                <span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse"></span>
                <span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse delay-200"></span>
                <span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse delay-400"></span>
                <span class="ml-2 muted">IA est√° digitando...</span>
            </span>
        </div>

        <!-- input -->
        <div class="p-3 bg-white shadow-inner">
            <form id="chat-form" class="flex gap-2 items-center">
                <input id="message-input" class="flex-1 p-3 rounded-full border border-gray-200" placeholder="Digite um c√≥digo EG ou comando..." autocomplete="off" />
                <button type="submit" class="w-12 h-12 rounded-full bg-amber-500">‚ñ∂</button>
                <button type="button" id="btn-test-eg" class="ml-2 px-3 py-2 rounded bg-green-600 text-white">üß™ 67285-8</button>
                <button type="button" id="btn-test-ia" class="ml-2 px-3 py-2 rounded bg-blue-600 text-white">üß™ Teste IA</button>
            </form>
        </div>

        <!-- overlay loading -->
        <div id="overlay-loading" class="overlay-loading">
            <div class="flex flex-col items-center gap-4">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
                <div class="text-white">Carregando planilha...</div>
            </div>
        </div>
    </div>

    <script>
    /*************************************************************************
     * C√≥digo JS completo e otimizado
     * - Usa PapaParse para CSV
     * - Fallback de proxy para CORS
     * - Normaliza√ß√£o de headers (remove acentos)
     * - Busca robusta por EG e por outros campos
     * - Fallback IA local quando Gemini falha ou key n√£o presente
     *************************************************************************/

    // ========== CONFIG ==========
    const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZiOyvly3nMqoNnJSj7_is0d-mMGGXmeIpXfYEHL2SqQAfNQ5tU4oOsNQsOhi7TKjcBxy2XoWmt2oe/pub?output=csv";
    // Substitua pela sua chave Gemini se quiser usar a IA remota
    const GEMINI_API_KEY = ""; // <-- coloque sua chave aqui (ou deixe vazio para usar IA local)

    // state
    let parsedData = [];     // array de objetos (PapaParse header:true)
    let headerMap = {};      // mapa: keyNormalized -> original header name
    let isSheetLoaded = false;
    let isSheetLoading = false;

    // DOM refs
    const welcomeScreen = document.getElementById('welcome-screen');
    const phoneContainer = document.getElementById('phone-container');
    const startButton = document.getElementById('start-chat-button');
    const forcePreload = document.getElementById('force-preload');
    const closeChatBtn = document.getElementById('close-chat-button');
    const chatStatus = document.getElementById('chat-status');
    const progressBar = document.getElementById('progress-bar');
    const messageContainer = document.getElementById('message-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const overlayLoading = document.getElementById('overlay-loading');

    // UTIL: remover acentos e normalizar
    function normalizeKey(str = '') {
        if (!str) return '';
        // remove espa√ßos extras, transforma em minusculas e remove acentos
        return str.toString().trim().toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9\s_-]/g, '') // remove s√≠mbolos indesejados
            .replace(/\s+/g, ' ');
    }

    // UTIL: show / hide typing
    function showTyping() { typingIndicator.classList.remove('hidden'); messageContainer.scrollTop = messageContainer.scrollHeight; }
    function hideTyping() { typingIndicator.classList.add('hidden'); }

    // UTIL: adicionar mensagem no chat
    function addMessage(content, sender = 'bot') {
        const div = document.createElement('div');
        div.className = 'message ' + (sender === 'user' ? 'user' : 'bot');
        div.innerHTML = content.replace(/\n/g, '<br>');
        messageContainer.appendChild(div);
        // smooth scroll
        setTimeout(() => {
            messageContainer.scrollTo({ top: messageContainer.scrollHeight, behavior: 'smooth' });
        }, 45);
    }

    // UTIL: atualizar progresso visual
    function setProgress(pct) {
        progressBar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    // ========== PARSE & LOAD ==========
    async function preloadSheetData() {
        if (isSheetLoading || isSheetLoaded) return;
        isSheetLoading = true;
        overlayLoading.classList.add('show');
        chatStatus.textContent = 'Carregando planilha...';
        setProgress(10);

        const proxies = [
            `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_SHEET_CSV_URL)}`,
            `https://corsproxy.io/?${encodeURIComponent(GOOGLE_SHEET_CSV_URL)}`,
            `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(GOOGLE_SHEET_CSV_URL)}`
        ];

        let csvText = '';
        let success = false;

        for (let i = 0; i < proxies.length; i++) {
            const url = proxies[i];
            try {
                setProgress(10 + Math.round((i / proxies.length) * 50));
                const resp = await fetch(url, { method: 'GET', cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const text = await resp.text();
                // Heur√≠stica simples para verificar se devolveu CSV (n√£o HTML de erro)
                if (text && text.length > 50 && !text.trim().startsWith('<')) {
                    csvText = text;
                    success = true;
                    console.log('‚úÖ Planilha baixada via proxy:', url.split('?')[0]);
                    break;
                }
            } catch (err) {
                console.warn('proxy falhou:', url.split('?')[0], err.message);
                // continue
            }
        }

        // se nada funcionou, tente o link direto (pode falhar por CORS)
        if (!success) {
            try {
                setProgress(70);
                const resp = await fetch(GOOGLE_SHEET_CSV_URL, { method: 'GET', cache: 'no-store' });
                if (resp.ok) {
                    const text = await resp.text();
                    if (text && text.length > 50 && !text.trim().startsWith('<')) {
                        csvText = text;
                        success = true;
                        console.log('‚úÖ Planilha baixada diretamente (sem proxy)');
                    }
                }
            } catch (err) {
                console.warn('download direto falhou', err.message);
            }
        }

        // fallback: se ainda sem csvText, carrega dados de teste (para evitar que tudo quebre)
        if (!success) {
            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel baixar a planilha. Usando dados de teste.');
            csvText = `EG,Rede,Nome Fantasia,COORDENADOR,GN,SL/SC,M-1,M0,vs M-1,Gondola,Ponto Extra,Atendimento\n67285-8,Rede F,Estabelecimento 6,Julia Santos,1006,Vespasiano,25,28,7%,18,15\n75668-7,Rede A,Estabelecimento 1,Jo√£o Silva,1001,BH Norte,12,15,20%,8,5`;
        }

        setProgress(80);

        try {
            // PapaParse parse com header:true
            const parsed = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                transformHeader: h => h ? h.trim() : h
            });

            if (!parsed || !parsed.data || !parsed.data.length) throw new Error('CSV vazio ou formato inv√°lido');

            // normalizar headerMap
            headerMap = {};
            Object.keys(parsed.data[0]).forEach(origHeader => {
                const key = normalizeKey(origHeader);
                if (!key) return;
                if (!headerMap[key]) headerMap[key] = origHeader; // guardo o original para leitura
            });

            parsedData = parsed.data.map(row => {
                // garanta que todas as chaves originais existam
                const normalizedRow = {};
                Object.keys(row).forEach(orig => {
                    const key = normalizeKey(orig);
                    normalizedRow[key] = row[orig];
                });
                return normalizedRow;
            });

            isSheetLoaded = true;
            chatStatus.textContent = 'Base de dados carregada';
            setProgress(100);

            // mensagem de sucesso
            addMessage(`<strong>‚úÖ Base de dados carregada com sucesso!</strong><br>Registros: ${parsedData.length}<br>Voc√™ pode digitar um <strong>c√≥digo EG</strong> (ex: 67285-8) ou usar /ajuda.`, 'bot');

            console.log('Headers normalizados:', Object.keys(headerMap));
            console.log('Primeiras linhas:', parsedData.slice(0, 3));

        } catch (err) {
            console.error('Erro ao processar CSV:', err);
            chatStatus.textContent = 'Erro ao processar planilha';
            addMessage(`<strong>‚ùå Erro ao processar a planilha:</strong><br>${err.message}`, 'bot');
        } finally {
            isSheetLoading = false;
            overlayLoading.classList.remove('show');
            setTimeout(() => setProgress(0), 700);
        }
    }

    // ========== BUSCAS ==========
    // busca s√≠ncrona (usa parsedData j√° carregado)
    function findDataInSheetSync(code) {
        if (!isSheetLoaded || !parsedData.length) return null;

        const normalizedCode = code.toString().trim().toLowerCase();

        // poss√≠veis chaves para EG: 'eg', 'codigo', 'codigo eg', 'codigoeg'
        const candidateKeys = ['eg', 'codigo', 'codigo eg', 'codigoeg', 'cod', 'cod eg'];

        // busca exata por EG em qualquer registro
        for (const row of parsedData) {
            for (const key of candidateKeys) {
                if (row[key]) {
                    const cell = row[key].toString().trim().toLowerCase();
                    if (cell === normalizedCode) return row;
                }
            }
        }

        // se n√£o encontrou exata, tente busca por substring em colunas chave (nome, rede)
        const searchKeys = ['nome fantasia', 'nome', 'rede', 'estabelecimento'];
        for (const row of parsedData) {
            for (const k of searchKeys) {
                const val = row[k];
                if (val && val.toString().toLowerCase().includes(normalizedCode)) {
                    return row;
                }
            }
        }

        return null;
    }

    // busca por termo (com /buscar)
    function searchByTerm(term) {
        term = term.toString().trim().toLowerCase();
        if (!isSheetLoaded) return [];
        const results = parsedData.filter(row => {
            // verifica nome, rede, coordenador, etc
            const cols = ['nome fantasia','nome','rede','coordenador','supervisor'];
            for (const c of cols) {
                if (row[c] && row[c].toString().toLowerCase().includes(term)) return true;
            }
            return false;
        });
        return results;
    }

    // ========== IA: CHAMADA REMOTA (GEMINI) OU FALLBACK LOCAL ==========
    // fallback local fornece an√°lise simples (muito √∫til quando sem chave)
    function localAnalysisForRow(row) {
        // Tenta usar campos conhecidos (m0, m-1, vs m-1 etc.)
        const m0 = parseFloat((row['m0'] || row['m0 '] || row['m 0'] || '').toString().replace(',', '.')) || null;
        const m1 = parseFloat((row['m-1'] || row['m-1 '] || row['m 1'] || '').toString().replace(',', '.')) || null;
        const gondola = row['gondola'] || row['g√¥ndola'] || row['gondola '] || '';
        const pontoExtra = row['ponto extra'] || row['pontoextra'] || row['ponto extra '] || '';

        let analysis = `An√°lise r√°pida do estabelecimento "${row['nome fantasia'] || row['nome'] || '(sem nome)'}":\n\n`;
        if (m0 !== null && m1 !== null) {
            const diff = (m0 - m1);
            const pct = (m1 === 0) ? (m0 === 0 ? 0 : 100) : ((diff / Math.abs(m1)) * 100);
            analysis += `‚Ä¢ Performance: M0 = ${m0}, M-1 = ${m1}. Varia√ß√£o: ${diff >= 0 ? '+' : ''}${diff.toFixed(2)} (${pct.toFixed(1)}%).\n`;
            if (pct >= 10) analysis += `  ‚Üí Bom crescimento em rela√ß√£o ao m√™s anterior.\n`;
            else if (pct <= -10) analysis += `  ‚Üí Queda significativa, investigar causas (atendimento, exposi√ß√£o, estoque).\n`;
            else analysis += `  ‚Üí Varia√ß√£o est√°vel.\n`;
        } else {
            analysis += `‚Ä¢ Performance: Dados M0 e/ou M-1 indispon√≠veis para c√°lculo.\n`;
        }

        if (gondola) analysis += `‚Ä¢ G√¥ndola: ${gondola}\n`;
        if (pontoExtra) analysis += `‚Ä¢ Ponto Extra: ${pontoExtra}\n`;

        analysis += `\nSugest√µes:\n‚Ä¢ Verificar exposi√ß√£o do produto (g√¥ndola/ponto extra).\n‚Ä¢ Conferir status de atendimento e frequ√™ncia de visita.\n‚Ä¢ Investigar promo√ß√µes ou rupturas no per√≠odo.\n`;

        return analysis;
    }

    async function callGeminiAPI(userMessage) {
        // Se n√£o tem chave, retorna fallback local (string)
        if (!GEMINI_API_KEY || GEMINI_API_KEY.trim().length < 5) {
            console.warn('GEMINI key ausente ‚Äî usando an√°lise local.');
            return `‚ö†Ô∏è (Resposta gerada localmente) \n\n${userMessage}`;
        }

        try {
            // construir prompt simples ‚Äî voc√™ pode adaptar
            const prompt = `Voc√™ √© um assistente anal√≠tico para a DIRETA MG. Responda em Portugu√™s. Usu√°rio pergunta: ${userMessage}`;
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            if (!resp.ok) {
                throw new Error(`API Error: ${resp.status} ${resp.statusText}`);
            }
            const data = await resp.json();
            // navegue no formato de retorno (pode mudar, trate com cuidado)
            if (data?.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                return data.candidates[0].content.parts[0].text;
            } else if (data?.output?.[0]?.content?.text) {
                return data.output[0].content.text;
            } else {
                return 'Desculpe ‚Äî resposta da API inv√°lida.';
            }
        } catch (err) {
            console.error('Erro Gemini:', err);
            return `‚ùå Erro na conex√£o com a IA remota: ${err.message}\n\nVou usar a an√°lise local como fallback.`;
        }
    }

    // ========== PROCESSAMENTO MENSAGEM ==========

    // detecta padr√£o EG (mais permissivo)
    const egPattern = /\d{2,6}-\d/;

    async function processMessage(message) {
        const raw = message.toString().trim();
        if (!raw) return;

        // comandos:
        const lower = raw.toLowerCase();
        if (lower === '/ajuda' || lower === 'ajuda') {
            addMessage(`<strong>üí° Comandos:</strong><br>‚Ä¢ Digite um <strong>c√≥digo EG</strong> (ex: 67285-8)<br>‚Ä¢ <strong>/buscar termo</strong> - busca por nome/rede<br>‚Ä¢ <strong>/status</strong> - status do sistema<br>‚Ä¢ <strong>/logo</strong> - info da interface`, 'bot');
            return;
        }
        if (lower.startsWith('/buscar')) {
            const term = raw.replace('/buscar', '').trim();
            if (!term) { addMessage('Use /buscar [termo] ‚Äî exemplo: /buscar Belo Horizonte', 'bot'); return; }
            const results = searchByTerm(term);
            if (!results.length) { addMessage('Nenhum resultado encontrado para <strong>' + term + '</strong>.', 'bot'); return; }
            let html = `<strong>üîé Resultados (${results.length}):</strong><br>`;
            results.slice(0,10).forEach(r => {
                html += `‚Ä¢ <strong>${r['nome fantasia'] || r['nome'] || '(sem nome)'}</strong> ‚Äî ${r['rede'] || '(sem rede)'} ‚Äî EG: ${r['eg'] || r['codigo'] || '-'}<br>`;
            });
            addMessage(html, 'bot');
            return;
        }
        if (lower === '/status' || lower === 'status') {
            addMessage(`<strong>üìä Status:</strong><br>Base: ${isSheetLoaded ? '‚úÖ Carregada' : '‚ùå N√£o carregada'}<br>Registros: ${parsedData.length || 0}`, 'bot');
            return;
        }
        if (lower === '/logo' || lower === 'logo') {
            addMessage(`<strong>üé® Interface DIRETA MG</strong><br>Cores Ambev / BEES. Mobile-first.`, 'bot');
            return;
        }

        // se for EG -> busca detalhada
        if (egPattern.test(raw)) {
            addMessage(`<strong>üë§ Voc√™:</strong> ${raw}`, 'user');
            showTyping();
            setTimeout(() => {
                const row = findDataInSheetSync(raw);
                hideTyping();
                if (row) {
                    // gera an√°lise local e tenta IA remota (melhor fluxo: tenta remota, se falhar, devolve local)
                    const localAnalysis = localAnalysisForRow(row);
                    addMessage(`<strong>‚úÖ C√≥digo ${raw} encontrado!</strong><br>
<strong>Nome:</strong> ${row['nome fantasia'] || row['nome'] || '(n√£o informado)'}<br>
<strong>Rede:</strong> ${row['rede'] || '(n√£o informado)'}<br>
<strong>Coordenador:</strong> ${row['coordenador'] || '(n√£o informado)'}<br><br>
<strong>üîé An√°lise (local):</strong><br>${localAnalysis}`, 'bot');

                    // tenta enriquecer com IA remota assincronamente (mostra aviso se conseguir)
                    (async () => {
                        if (!GEMINI_API_KEY) return; // sem chave: pula
                        showTyping();
                        const prompt = `Forne√ßa uma an√°lise concisa e pr√°tica do estabelecimento abaixo, destacando pontos de a√ß√£o:\n\n${JSON.stringify(row, null, 2)}\n\nResponda em portugu√™s, m√°ximo 6 bullets.`;
                        const aiResp = await callGeminiAPI(prompt);
                        hideTyping();
                        if (aiResp && !aiResp.startsWith('‚ùå')) {
                            addMessage(`<strong>ü§ñ IA Remota (enriquecida):</strong><br>${aiResp}`, 'bot');
                        }
                    })();

                } else {
                    addMessage(`<strong>‚ùå C√≥digo ${raw} n√£o encontrado</strong><br>‚Ä¢ Verifique se o c√≥digo est√° correto<br>‚Ä¢ Use /buscar [termo] para procurar por nome ou rede`, 'bot');
                }
            }, 700);
            return;
        }

        // se n√£o for EG nem comando -> encaminha pra IA (ou echo + fallback)
        addMessage(`<strong>üë§ Voc√™:</strong> ${raw}`, 'user');
        showTyping();
        // se tiver base carregada, envie prompt com contexto reduzido
        const quickContext = isSheetLoaded ? `Base de dados carregada. Registros: ${parsedData.length}.` : 'Base de dados n√£o carregada.';
        const prompt = `${quickContext}\nUsu√°rio: ${raw}\nResponda de forma objetiva e em portugu√™s.`;
        const aiAnswer = await (GEMINI_API_KEY ? callGeminiAPI(prompt) : Promise.resolve('(resposta local) ' + raw));
        hideTyping();
        addMessage(`ü§ñ <strong>Rob√¥ IA:</strong><br>${aiAnswer}`, 'bot');
    }

    // ========== EVENTOS UI ==========
    startButton.addEventListener('click', () => {
        welcomeScreen.style.display = 'none';
        phoneContainer.classList.remove('hidden');
        // welcome message
        setTimeout(() => {
            addMessage(`<strong>üöÄ Bem-vindo ao Raio-X Score 5!</strong><br>Digite um c√≥digo EG (ex: 67285-8) ou /ajuda.`, 'bot');
        }, 350);
        // inicia preload automaticamente
        setTimeout(preloadSheetData, 600);
    });

    forcePreload.addEventListener('click', () => {
        preloadSheetData();
    });

    closeChatBtn.addEventListener('click', () => {
        phoneContainer.classList.add('hidden');
        welcomeScreen.style.display = 'flex';
    });

    // form submit
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        await processMessage(text);
    });

    // quick test buttons
    document.getElementById('btn-test-eg').addEventListener('click', () => {
        processMessage('67285-8');
    });
    document.getElementById('btn-test-ia').addEventListener('click', () => {
        processMessage('Oi, como vai? Me explique rapidamente sobre a base de dados.');
    });

    // inicia anima√ß√£o do subtitulo
    (function animateSubtitle() {
        const subtitle = document.getElementById('subtitle-typing');
        const messages = ["ü§ñ IA Conversacional da DIRETA MG","üìä An√°lise de Performance de Lojas","üéØ Consultas Inteligentes de C√≥digo EG","‚ö° Sistema Ambev Parceiro BEES"];
        let idx = 0;
        function type(msg, i=0) {
            if (i <= msg.length) {
                subtitle.textContent = msg.slice(0,i);
                setTimeout(() => type(msg, i+1), 28);
            } else {
                setTimeout(() => erase(msg), 1800);
            }
        }
        function erase(msg, i=msg.length) {
            if (i >= 0) {
                subtitle.textContent = msg.slice(0,i);
                setTimeout(() => erase(msg, i-1), 18);
            } else {
                idx = (idx + 1) % messages.length;
                setTimeout(() => type(messages[idx]), 400);
            }
        }
        setTimeout(() => type(messages[0]), 600);
    })();

    // limpa eventuais timeouts ao fechar
    window.addEventListener('beforeunload', () => { /* nada */ });

    // fim do script
    </script>
</body>
</html>
